<link rel="import" href="../polymer/polymer.html"> 
<link rel="import" href="../th-theme/th-theme.html"> 
<link rel="import" href="../th-d3-chart/th-d3-chart.html"> 

<!--
A Thelma component that wraps the Highcharts library
##### Example

    <th-highcharts></th-highcharts>

@element th-highcharts
@blurb A Thelma component that wraps the Highcharts library
@status alpha
@author Thelma team
@homepage http://thelmanews.github.io/th-highcharts
-->

<polymer-element name="th-highcharts" extends="th-d3-chart"  attributes="chartType chartTitle chartSubtitle chartOptions source sourceURL series1Name series2Name series3Name yAxisTitle xAxisTitle legendTitle yAxisMin yAxisMax yAxisInterval valuePrefix valueSuffix valueDecimals thousandsSep">
  
  <template>
    <core-style ref="theme"></core-style>
    <link rel="stylesheet" href="th-highcharts.css">
    <div id="chart" class="th-container"></div>
  </template>
  
  <!-- Include Highcharts library-->
  <script src="../highcharts/adapters/standalone-framework.js"></script>
  <script src="../highcharts/highcharts.js"></script>

  <script>
    Polymer('th-highcharts', {
      chartData: [[    
                ["The Wall Street Journal", 2293798],
                ["USA Today", 1713833],
                ["New York Times", 1613865],
                ["Los Angeles Times", 606075],    
                ["New York Daily News", 530440]
              ],
              [  ["The Wall Street Journal", 2503798],
                ["USA Today", 1413833],    
                ["New York Times", 1913865],    
                ["Los Angeles Times", 716075],    
                ["New York Daily News", 580440
              ]
      ]],
      chartType: 'bar',
      chartOptions: {
        // TODO: set basic default options
      }, 
      sourceURL: 'http://www.wsj.com/',
      source: 'The Wall Street Journal',
      series1Name: 'Series 1',
      series2Name: 'Series 2',
      series3Name: 'Series 3',
      yAxisTitle: '',
      xAxisTitle: '',
      thousandsSep: ',',
      valueDecimals: 0,
      ready: function () {
        this._overrideDefaults();
        this._buildChart();
        var chart = new Highcharts.Chart(this.chartOptions);
        
        // var chart = new Highcharts.Chart({
        //       chart: {
        //         renderTo: this.$.chart,
        //         type: this.chartType
        //       },
        //       title: {
        //           text: 'Fruit Consumption'
        //       },
        //       xAxis: {
        //           categories: ['Apples', 'Bananas', 'Oranges']
        //       },
        //       yAxis: {
        //           title: {
        //               text: 'Fruit eaten'
        //           }
        //       },
        //       series: [{
        //           name: 'Jane',
        //           data: [1, 0, 4]
        //       }, {
        //           name: 'John',
        //           data: [5, 7, 3]
        //       }]
        //   });

      
      },
      _overrideDefaults: function(){
        // Select container for chart
        this.chartOptions.chart.renderTo = this.$.chart;

        // Parse data and convert to Highcharts compatible format
        this.chartOptions.series = this._parseData(this.chartData);

        // TODO: Set dimensions of chart based on component dimensions
        // this.chartOptions.chart.height = 500;
        // this.chartOptions.chart.width = 500;

        // Set and align title and subtitle
        this.chartOptions.title = {
          align: 'left',
          text: this.chartTitle
        };
        this.chartOptions.subtitle = {
          align: 'left',
          text: this.chartSubtitle
        };

        // Override default yAxis title (Values)
        this.chartOptions.yAxis.title = this.chartOptions.yAxis.title || {};
        this.chartOptions.yAxis.title.text = this.yAxisTitle || '';

        // Override default credits (highcharts.com)
        this.chartOptions.credits = {
          href: this.sourceURL,
          text: this.source,
          position: {
            align: 'left',
            x: 10
          }
        };

        // Override ability to click on bar, which changes color to gray
        this.chartOptions.plotOptions.bar.allowPointSelect = false;

        // Override original padding, which sets the legend too close to the chart
        this.chartOptions.legend.padding = 0;

        // Override y-axis label rotation
        this.chartOptions.yAxis.labels.autoRotation = -45;

        // Set value formats with prefix, suffix, etc.
        this.chartOptions.tooltip = this.chartOptions.tooltip || {};
        this.chartOptions.tooltip.valuePrefix = this.valuePrefix;
        this.chartOptions.tooltip.valueSuffix = this.valueSuffix;
        this.chartOptions.tooltip.valueDecimals = this.valueDecimals;
        this.chartOptions.tooltip.xDateFormat = this.xDateFormat;
        // TODO: prefix/suffix is not working

      },
      _parseData: function(data){
        var chartData = [];

        // If data structure is array
        if (Array.isArray(data)){
          data.forEach(function(series){
            // If each item in array is array
            if (Array.isArray(series)){
              // TODO: account for scenario when first item in array represents series names
              var seriesObj = {
                data: series
              };
              chartData.push(seriesObj);
            
            // If each item in array is an object
            } else if (typeof(series) === 'object'){
              // TODO: convert to array format with series names

            }

          })
        }

        return chartData;
      },
      _buildChart: function(){
        this.chartOptions.chart.renderTo = this.$.chart;
        this.chartOptions.series = this._parseData(this.chartData);
      },
      animate: function(){
       
      },
      reset: function(){
       
      },
      
      resize: function(){
       
      }

    });
  </script>
</polymer-element>
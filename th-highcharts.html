<link rel="import" href="../polymer/polymer.html"> 
<link rel="import" href="../th-theme/th-theme.html"> 
<link rel="import" href="../th-d3-chart/th-d3-chart.html"> 

<!--
A Thelma component that wraps the Highcharts library
##### Example

    <th-highcharts></th-highcharts>

@element th-highcharts
@blurb A Thelma component that wraps the Highcharts library
@status alpha
@author Thelma team
@homepage http://thelmanews.github.io/th-highcharts
-->

<polymer-element name="th-highcharts" extends="th-d3-chart"  attributes="chartType chartTitle chartSubtitle chartOptions credits creditsURL series1Name series2Name series3Name yAxisTitle xAxisTitle legendTitle yAxisMin yAxisMax yAxisInterval valuePrefix valueSuffix valueDecimals thousandsSep chartWidth chartHeight legend seriesColors textColor backgroundColor xTickInterval yTickInterval gridLineColor">
  
  <template>
    <core-style ref="theme"></core-style>
    <link rel="stylesheet" href="th-highcharts.css">
    <div id="chart" class="th-container"></div>
  </template>
  
  <!-- Include Highcharts library-->
  <script src="../highcharts/adapters/standalone-framework.js"></script>
  <script src="../highcharts/highcharts.js"></script>

  <script>
    Polymer('th-highcharts', {
      chartData: [[    
                ["The Wall Street Journal", 2293798],
                ["USA Today", 1713833],
                ["New York Times", 1613865],
                ["Los Angeles Times", 606075],    
                ["New York Daily News", 530440]
              ],
              [  ["The Wall Street Journal", 2503798],
                ["USA Today", 1413833],    
                ["New York Times", 1913865],    
                ["Los Angeles Times", 716075],    
                ["New York Daily News", 580440
              ]
      ]],
      chartType: 'bar',
      chartOptions: {
        // TODO: set basic default options
      }, 
      creditsURL: 'http://www.wsj.com/',
      credits: 'The Wall Street Journal',
      series1Name: 'Series 1',
      series2Name: 'Series 2',
      series3Name: 'Series 3',
      yAxisTitle: '',
      xAxisTitle: '',
      thousandsSep: ',',
      legend: true,
      valueDecimals: 0,
      seriesColors: [],
      textColor: '',
      backgroundColor: '',
      gridLineColor: '',
      valuePrefix: '$',
      observe: {
        'legend': '_setupChart',
        'chartWidth': 'resize',
        'chartHeight': 'resize'
      },
      ready: function () {
        this._setupChart();
        this._buildChart();
        this.chart = new Highcharts.Chart(this.chartOptions);
      },
      _setupChart: function(){
        // Select container for chart
        this.chartOptions.chart.renderTo = this.$.chart;

        // Parse data and convert to Highcharts compatible format
        this.seriesData = this._parseData(this.chartData);
        // this.seriesDataStart = this.seriesData.map(function(series){
        //   var startingData = series.data.map(function(value){return 0;});
        //   series.data = startingData;
        //   return series;
        // })

        this._setDimensions();
        this._overrideDefaultSettings();
        this._setupTitles();
        this._setupAxes();
        this._formatValues();
        this._applyThemeColors();
        
      },
      _parseData: function(data){
        var self = this;
        var chartData = [];

        // If data structure is array
        if (Array.isArray(data)){
          data.forEach(function(row){
            // If each item in array is array
            if (Array.isArray(row)){
              // TODO: account for scenario when first item in array represents series names
              var seriesObj = {
                data: row
              };
              
              chartData.push(seriesObj);
            
            // If each item in array is an object
            } else if (typeof(row) === 'object'){
              // This is specific to Thelma formatted data which has 'label', 'series1', 'series2', 'series3' properties
              if (row.label && row.series1){
                this.thelmaData = true;
              } else {
                // TODO: find a way to parse data in a normal / not-Thelma way and incorporate here
              }
            }
          })
          if (thelmaData){chartData = self._parseDataThelma(data); };
        }

        return chartData;
      },
      /**
       * '_parseDataThelma' expects data to be in the format of an array of objects, with 
       */
      _parseDataThelma: function(data){
        var chartData = [];
        
        // Set x-axis labels
        this.chartOptions.xAxis.categories = data.map(function(row){ return row.label; });

        // Divide up series data 
        for(var i=1; i<=3; i++){
          // Skip if there is no data in a series
          if (!data[0]['series'+i] || data[0]['series'+i] === 0){
            continue;
          }

          // Otherwise, create Highcharts series object
          var series = {};
          series.style = {opacity: 0};
          series.name = this['series'+i+'Name'];
          series.data = data.map(function(row){ 
            var value = row['series'+i];
            if (value || value === 0){
              return parseFloat(value); // convert string values into numbers
            }
          });

          chartData.push(series); // collect all series in chartData
        }
        return chartData;
      },

      _setDimensions: function(){
        // chartWidth and chartHeight are calculated in parent element due to faster load time
        this.chartOptions.chart.width = this.chartWidth;
        this.chartOptions.chart.height = this.chartHeight;
      },
      _overrideDefaultSettings: function(){
        // Override default yAxis title (Values)
        this.chartOptions.yAxis.title = this.chartOptions.yAxis.title || {};
        this.chartOptions.yAxis.title.margin = 5; // distance between axis labels and title

        // Override y-axis label rotation
        this.chartOptions.yAxis.labels.autoRotation = -45;

        // Override default yAxis title (Values)
        this.chartOptions.xAxis.title = this.chartOptions.xAxis.title || {};
        this.chartOptions.xAxis.title.margin = 5; // distance between axis labels and title

        // Override default credits (highcharts.com)
        this.chartOptions.credits = {
          href: this.creditsURL,
          text: this.credits,
          position: {
            align: 'left',
            x: 10
          }
        };

        // Override ability to click on bar, which changes color to gray
        this.chartOptions.plotOptions.bar.allowPointSelect = false;

        // Override original padding, which sets the legend too close to the chart
        if (this.legend){
          this.chartOptions.chart.marginBottom = 80;
        } else {
          this.chartOptions.legend.enabled = false;
        }

        // Remove the border on bars
        // TODO: make this work for different types of charts
        this.chartOptions.plotOptions.bar = this.chartOptions.plotOptions.bar || {};
        this.chartOptions.plotOptions.bar.borderWidth = 0;


      },
      
      _setupTitles: function(){
        // Set and align title and subtitle
        this.chartOptions.title = {
          align: 'left',
          text: this.chartTitle
        };
        this.chartOptions.subtitle = {
          align: 'left',
          text: this.chartSubtitle
        };        

        
      },
      _setupAxes: function(){
        this.chartOptions.xAxis.title = this.chartOptions.xAxis.title || {};
        this.chartOptions.xAxis.title.text = this.xAxisTitle || '';  
        
        this.chartOptions.yAxis.title = this.chartOptions.yAxis.title || {};
        this.chartOptions.yAxis.title.text = this.yAxisTitle || '';  

        this.chartOptions.yAxis.tickInterval = this.yTickInterval;
        this.chartOptions.xAxis.tickInterval = this.xTickInterval;

      },
      _formatValues: function(){
        var self = this;
        var prefix = self.valuePrefix || '';
        var suffix = self.valueSuffix || '';
        this.chartOptions.yAxis.labels.formatter = function(){
          return prefix + Highcharts.numberFormat(this.value, self.valueDecimals, '.', self.thousandsSep) + suffix;
        }
      },
      _applyThemeColors: function(){
        // TODO: refactor all of the below
        var colors = this.getColors();
        
        var fgColor = this.textColor || colors.theme.foreground1 || "black";
        var bgColor = this.backgroundColor || "none";
        var seriesColors;

        // Create array of colors, where each color applies to that series index
        if (this.seriesColors && this.seriesColors.length){
          seriesColors = this.seriesColors.map(function(colorObj, i){ 
            // Sometimes composer returns null instead of object and sometimes "" for color property
            return colorObj && colorObj.color ? colorObj.color : colors.accents[i];
          });
        } else {
          seriesColors = colors.accents;
        }
        
        // Apply series colors
        this.chartOptions.colors = seriesColors;

        // Apply text color to axis values, titles, legend

        this.chartOptions.xAxis.title.style = this.chartOptions.xAxis.title.style || {};
        this.chartOptions.xAxis.title.style.color = fgColor;
        this.chartOptions.xAxis.labels.style.color = fgColor;
        this.chartOptions.xAxis.gridLineColor = this.gridLineColor || fgColor;
        this.chartOptions.xAxis.lineColor = this.gridLineColor || fgColor;
        this.chartOptions.xAxis.tickColor = this.gridLineColor || fgColor;
        
        this.chartOptions.yAxis.title.style = this.chartOptions.yAxis.title.style || {};
        this.chartOptions.yAxis.title.style.color = fgColor;
        this.chartOptions.yAxis.labels.style.color = fgColor;
        this.chartOptions.yAxis.gridLineColor = this.gridLineColor || fgColor;
        this.chartOptions.yAxis.tickColor = this.gridLineColor || fgColor;
        

        
        this.chartOptions.title.style = this.chartOptions.title.style || {};
        this.chartOptions.subtitle.style = this.chartOptions.subtitle.style || {};
        this.chartOptions.title.style.color = this.chartOptions.subtitle.style.color = fgColor;

        this.chartOptions.legend.itemStyle.color = fgColor;
        this.chartOptions.chart.backgroundColor = bgColor || null;


      },

      _buildChart: function(){
        this.chartOptions.chart.renderTo = this.$.chart;
        this.chartOptions.series = this.seriesData;
      },
      animate: function(){
        // Reinstantiate the chart
        this.chart = new Highcharts.Chart(this.chartOptions);

        // TODO: delay animation until this is called instead of reinstantiating chart

      },
      reset: function(){
        var numSeries = this.seriesData.length;

        // Remove each series
        for (var i=0; i<numSeries; i++){
          this.chart.series[0].remove(true);
        }

      },
      resize: function(){
        // Reset dimensions in chartOptions
        this._setDimensions();
        this.animate();
        
        // Resize chart with animation
        // this.chart.setSize(this.chartWidth, this.chartHeight, doAnimation = true);
       
      }

    });
  </script>
</polymer-element>